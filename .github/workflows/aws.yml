name: CI/CD for ASP.NET Core with Docker Compose on EC2

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master


jobs:
  # build-and-push:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #     - name: Login to Docker Hub
  #       uses: docker/login-action@v3
  #       with:
  #         username: ${{ secrets.DOCKERHUB_USERNAME }}
  #         password: ${{ secrets.DOCKERHUB_TOKEN }}

  #     - name: Build and Push images
  #       run: |
  #         docker compose build --no-cache
  #         docker compose push

  deploy:
    runs-on: ubuntu-latest
    # needs: build-and-push

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
  
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
           dotnet-version: 9.0.x
        
      # - name: Restore dependencies ðŸ“‚
      #   run: dotnet restore ./Foruscorp.sln
      
      # - name: Build ðŸ§±
      #   run: dotnet build ./Foruscorp.sln --no-restore

      - name: Configure SSH
        run: |
            mkdir -p ~/.ssh/
            touch ~/.ssh/known_hosts
            chmod 644 ~/.ssh/known_hosts
            ls -l ~/.ssh/
            echo "${{ secrets.EC2_SSH_TEST_PRIVATE_KEY }}" > ~/.ssh/id_ed25519T
            chmod 600 ~/.ssh/id_ed25519T
            echo "Scanning host: ${{ secrets.EC2_TEST_HOST }}"
            ssh-keyscan -t rsa ${{ secrets.EC2_TEST_HOST }} >> ~/.ssh/known_hosts || true
            cat ~/.ssh/known_hosts

      - name: Deploy to EC2
        env:
          SAMSARA_API_TOKEN: ${{ secrets.SAMSARA_API_TOKEN }}
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_ed25519T ec2-user@${{ secrets.EC2_TEST_HOST}} '
          
            mkdir -p /home/ec2-user/TollService &&
            cd /home/ec2-user/TollService &&
            if [ ! -d .git ]; then
              git clone https://github.com/Monolit2000/TollService.git .;
            fi &&
            
            git checkout master &&
            git fetch --all &&
            git reset --hard origin/master &&
            git pull origin master &&
            echo 'SAMSARA_API_TOKEN=$SAMSARA_API_TOKEN' > .env &&
            echo 'SAMSARA_API_TOKEN written to .env' &&
            cat .env &&
            sudo docker-compose -f docker-compose.yml pull &&
            sudo docker-compose -f docker-compose.yml down &&
            sudo docker-compose -f docker-compose.yml up -d &&
            sudo docker system prune -a -f &&
            sudo docker ps '
          

      - name: Clean up SSH key
        if: always()
        run: |
          rm -f ~/.ssh/id_ed25519T
